#!/usr/bin/env ruby
#
# Copyright 2010 Louis-Philippe Salin de l'Etoile, aka Louis Salin
# email: louis.phil@gmail.com
#
# This file is part of Blux.
#
# Blux is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Blux is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Blux.  If not, see <http://www.gnu.org/licenses/>.

require 'atom/entry' # sudo gem install atom-tools
require "#{File.dirname(__FILE__)}/../lib/blux_option_parser.rb"
require "#{File.dirname(__FILE__)}/../lib/blog_manager.rb"

def validate_command(options)
	if (options.command != nil)
		yield options
	else
		msg = "No command specified. Use -h for a list of possible commands"
		raise RuntimeError, msg
	end
end

def validate_set_options(options)
	if options.attributes.length.modulo(2) == 0
		yield options.attributes[0], options.attributes[1]
	else
		msg = "Attribute error: you must specify an attribute name and a value."
		raise RuntimeError, msg
	end
end

def get_post_by_filename(options, blog_manager)
	post = blog_manager.post_manager.get_latest_created_post if options.use_latest
	post = blog_manager.post_manager.get_post_by_title(options.title) if options.use_title
	post = blog_manager.get_post options.filename if options.filename

	if post != nil
		yield post
	else
		msg = "Please specify the post file you want to work with.\n"
		msg = msg + "  Try using the --latest option to use the latest post.\n"
		msg = msg + "  Or try to get a post with a specific title with the --title option."

		raise RuntimeError, msg
	end
end

def build_post_info(options)
	switch = nil
	entry = Array.new
	response = Array.new
	url = ""

	ARGF.each do |line| 
		if line == "--entry--\n"
			switch = :entry
			next
		elsif line == "--response--\n"
			switch = :response
			next
		elsif line == "--url--\n"
			switch = :url
			next
		end

		case (switch)
		when :entry
			entry << line
		when :response
			response << line
		when :url
			url = line
		end
	end

	entry_text = entry.join
	response_text = response.join

	msg = "Error communicating with the publishing script. Exiting..."
	raise RuntimeError, msg if response.length == 0
	
	return entry, response, url
end

begin
	validate_command(BluxOptionParser.parse(ARGV)) do |options|
		post_manager = PostManager.new
		mgr = BlogManager.new(post_manager, :verbose => options.verbose)	
		mgr.start
		mgr.load_config

		case options.command
		when :new
			mgr.post_manager.create_post
		when :edit
			get_post_by_filename(options, mgr) {|post| post.edit}
		when :list
			mgr.post_manager.list.each do |item|
				break if options.filename != nil && options.filename != item
				puts "#{item}"
				puts "  #{mgr.post_manager.show_info(item)}" if options.list_details
				puts "  #{mgr.post_manager.show_preview(item)}" if options.list_preview
			end
		when :set
			get_post_by_filename(options, mgr) do |post|
				validate_set_options(options) do |attribute, value|
					mgr.post_manager.set_attribute(post.filename, attribute, value)
				end
			end
		when :unset
			get_post_by_filename(options, mgr) do |post|
				mgr.post_manager.delete_attribute(post.filename, options.attribute)
			end
		when :out
			get_post_by_filename(options, mgr) do |post|
				STDOUT.puts(post.text)
			end
		when :convert
			get_post_by_filename(options, mgr) do |post|
				convert_cmd = "ruby #{File.dirname(__FILE__)}/../lib/textile_to_html.rb"
				system "blux --out -f #{post.filename} | #{convert_cmd}"
			end
		when :publish
			get_post_by_filename(options, mgr) do |post|
				puts "publishing" if options.verbose
				post.publish
			end
		when :update
			get_post_by_filename(options, mgr) do |post|
				puts "updating" if options.verbose
				post.update
			end
		when :delete
			get_post_by_filename(options, mgr) do |post|
				puts "deleting" if options.verbose
				post.delete
			end
		when :show_post_info
			entry, response, url = build_post_info(options)
				if options.verbose
					puts "entry:" 
					puts entry 

					puts "response:" 
					puts response 

					puts "edit url:" 
					puts url 
				end
		when :set_edit_url
			get_post_by_filename(options, mgr) do |post|
				entry, response, url = build_post_info(options)

				if options.verbose
					puts "entry:" 
					puts entry 

					puts "response:" 
					puts response 

					puts "edit url:" 
					puts url 
				end

				post.edit_url = url.strip
			end
		when :version
			puts "0.0.6"
		end
	end
rescue 
	STDERR << "fatal error: #{$!}\n"
	exit 1
end

